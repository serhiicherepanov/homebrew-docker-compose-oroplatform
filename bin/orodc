#!/bin/bash
set -e
if [ "$DEBUG" ]; then set -x; fi

# Restore cursor visibility on exit
trap 'tput cnorm 2>/dev/null || true' EXIT

# Determine paths - resolve symlink to get actual installation directory
SCRIPT_PATH="${BASH_SOURCE[0]}"
# Follow symlink if it is one (for Homebrew installation)
if [ -L "$SCRIPT_PATH" ]; then
  SCRIPT_PATH="$(readlink -f "$SCRIPT_PATH")"
fi
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
# SCRIPT_DIR will be .../libexec, so orodc modules are in ./orodc/
LIBEXEC_DIR="${SCRIPT_DIR}/orodc"
# Export SCRIPT_DIR so sourced libraries can use it to find orodc-find_free_port
export SCRIPT_DIR

# Source all library files
source "${LIBEXEC_DIR}/lib/ui.sh"
source "${LIBEXEC_DIR}/lib/common.sh"
source "${LIBEXEC_DIR}/lib/port-manager.sh"
source "${LIBEXEC_DIR}/lib/docker-utils.sh"
source "${LIBEXEC_DIR}/lib/environment.sh"

# Handle version command (only "version", not --version)
if [[ "$1" == "version" ]]; then
  # Try to find and read version from Formula file
  FORMULA_VERSION=""
  FORMULA_FILE=""

  # Use find to locate Formula file, starting from script directory and going up
  # First try relative to script directory (for development)
  FORMULA_FILE=$(find "$SCRIPT_DIR" -name "docker-compose-oroplatform.rb" -type f 2>/dev/null | head -1)

  # If not found, try going up from script directory (for tap development)
  if [[ -z "$FORMULA_FILE" ]]; then
    SEARCH_DIR="$SCRIPT_DIR"
    while [[ "$SEARCH_DIR" != "/" ]] && [[ -z "$FORMULA_FILE" ]]; do
      FORMULA_FILE=$(find "$SEARCH_DIR" -maxdepth 2 -name "docker-compose-oroplatform.rb" -type f 2>/dev/null | head -1)
      SEARCH_DIR=$(dirname "$SEARCH_DIR")
    done
  fi

  # If not found relative to script, try brew repository
  if [[ -z "$FORMULA_FILE" ]] && command -v brew >/dev/null 2>&1; then
    BREW_REPO=$(brew --repository 2>/dev/null)
    if [[ -n "$BREW_REPO" ]]; then
      FORMULA_FILE=$(find "$BREW_REPO" -name "docker-compose-oroplatform.rb" -type f 2>/dev/null | head -1)
    fi
  fi

  # Extract version from Formula file
  if [[ -n "$FORMULA_FILE" && -f "$FORMULA_FILE" ]]; then
    FORMULA_VERSION=$(grep -o 'version "[^"]*"' "$FORMULA_FILE" 2>/dev/null | sed 's/version "\(.*\)"/\1/')
  fi

  # Output version or fallback
  if [[ -n "$FORMULA_VERSION" ]]; then
    echo "orodc version $FORMULA_VERSION"
  else
    echo "orodc version unknown (formula file not found)"
  fi
  exit 0
fi

# Handle help/man command
if [[ "$1" == "help" ]] || [[ "$1" == "man" ]]; then
  # Try to find README.md file
  README_FILE=""

  # Look for README.md in various locations
  # 1. Relative to script directory (development)
  if [[ -f "$SCRIPT_DIR/../README.md" ]]; then
    README_FILE="$SCRIPT_DIR/../README.md"
  elif [[ -f "$SCRIPT_DIR/README.md" ]]; then
    README_FILE="$SCRIPT_DIR/README.md"
  elif [[ -f "$SCRIPT_DIR/../../README.md" ]]; then
    README_FILE="$SCRIPT_DIR/../../README.md"
  fi

  # 2. Try to find in Homebrew tap directory
  if [[ -z "$README_FILE" ]] && command -v brew >/dev/null 2>&1; then
    BREW_REPO=$(brew --repository 2>/dev/null)
    if [[ -n "$BREW_REPO" ]]; then
      TAP_README="$BREW_REPO/Library/Taps/digitalspacestdio/homebrew-docker-compose-oroplatform/README.md"
      if [[ -f "$TAP_README" ]]; then
        README_FILE="$TAP_README"
      fi
    fi
  fi

  # If README found, display it without pager (always use cat)
  if [[ -n "$README_FILE" && -f "$README_FILE" ]]; then
    echo "==> OroDC Documentation"
    echo
    cat "$README_FILE"
  else
    echo "==> OroDC Help"
    echo
    msg_highlight "Documentation not found locally. Please visit:"
    echo "   https://github.com/digitalspacestdio/homebrew-docker-compose-oroplatform"
    echo
    msg_highlight "Quick Commands:"
    echo "   orodc version                    # Show version"
    echo "   orodc compose up -d              # Start services"
    echo "   orodc compose down               # Stop services"
    echo "   orodc compose ps                 # List services"
    echo "   orodc init                       # Initialize new project"
    echo
    msg_highlight "Command Groups:"
    echo "   orodc compose <cmd>              # Docker Compose commands"
    echo "   orodc database <subcmd>          # Database operations"
    echo "   orodc tests <subcmd>             # Testing commands"
    echo "   orodc proxy <subcmd>             # Proxy management"
    echo "   orodc image <subcmd>             # Image building"
    echo
    echo "ðŸ’¡ For full documentation, run: brew info docker-compose-oroplatform"
  fi
  exit 0
fi

# Initialize environment for most commands
# Skip for: help, version, proxy, image (these don't require project)
case "$1" in
  help|man|version|proxy|image|docker-build)
    # Skip initialization for these commands
    ;;
  *)
    # Initialize environment for all other commands (including menu when no args)
    # For menu, allow initialization to fail gracefully if not in project
    if [[ $# -eq 0 ]]; then
      # Menu case - try to initialize but don't fail if not in project
      initialize_environment 2>/dev/null || true
    else
      # Regular command - require initialization
      initialize_environment
    fi
    ;;
esac

# Handle VERBOSE toggle command
if [[ "$1" == "v" ]] || [[ "$1" == "verbose" ]]; then
  if [[ -n "${VERBOSE:-}" ]]; then
    unset VERBOSE
    echo "VERBOSE mode disabled"
  else
    export VERBOSE=1
    echo "VERBOSE mode enabled"
  fi
  exit 0
fi

# Show interactive menu when no arguments provided
if [[ $# -eq 0 ]]; then
  exec "${LIBEXEC_DIR}/menu.sh"
fi

# Store original command for menu return
ORIGINAL_CMD="$1"

# Helper function to execute command and return to menu if needed
# This ensures menu reflects 1:1 command line behavior - commands execute
# exactly as they would from command line, only difference is return to menu
execute_with_menu_return() {
  local script="$1"
  shift
  
  # Temporarily disable set -e to capture exit code
  set +e
  
  # Execute the script exactly as it would be executed from command line
  "$script" "$@"
  local exit_code=$?
  
  # Re-enable set -e
  set -e
  
  # Always add empty line after command execution
  echo "" >&2
  
  # If ORODC_IS_INTERACTIVE_MENU is set, return to menu after command
  # No additional output or processing - just return to menu
  if [[ -n "${ORODC_IS_INTERACTIVE_MENU:-}" ]]; then
    echo -n "Press Enter to continue..." >&2
    read -r
    exec "${LIBEXEC_DIR}/menu.sh"
  fi
  
  exit $exit_code
}

# Route commands to appropriate modules
case "$1" in
  # Docker Compose commands - route to compose.sh module
  compose)
    shift
    if [[ -n "${ORODC_IS_INTERACTIVE_MENU:-}" ]]; then
      execute_with_menu_return "${LIBEXEC_DIR}/compose.sh" "$@"
    else
      exec "${LIBEXEC_DIR}/compose.sh" "$@"
    fi
    ;;

  # Database commands - route to database/*.sh modules
  database|db)
    shift
    case "$1" in
      mysql)
        shift
        if [[ -n "${ORODC_IS_INTERACTIVE_MENU:-}" ]]; then
          execute_with_menu_return "${LIBEXEC_DIR}/database/mysql.sh" "$@"
        else
          exec "${LIBEXEC_DIR}/database/mysql.sh" "$@"
        fi
        ;;
      psql)
        shift
        if [[ -n "${ORODC_IS_INTERACTIVE_MENU:-}" ]]; then
          execute_with_menu_return "${LIBEXEC_DIR}/database/psql.sh" "$@"
        else
          exec "${LIBEXEC_DIR}/database/psql.sh" "$@"
        fi
        ;;
      import)
        shift
        if [[ -n "${ORODC_IS_INTERACTIVE_MENU:-}" ]]; then
          execute_with_menu_return "${LIBEXEC_DIR}/database/import.sh" "$@"
        else
          exec "${LIBEXEC_DIR}/database/import.sh" "$@"
        fi
        ;;
      export)
        shift
        if [[ -n "${ORODC_IS_INTERACTIVE_MENU:-}" ]]; then
          execute_with_menu_return "${LIBEXEC_DIR}/database/export.sh" "$@"
        else
          exec "${LIBEXEC_DIR}/database/export.sh" "$@"
        fi
        ;;
      cli)
        shift
        if [[ -n "${ORODC_IS_INTERACTIVE_MENU:-}" ]]; then
          execute_with_menu_return "${LIBEXEC_DIR}/database/cli.sh" "$@"
        else
          exec "${LIBEXEC_DIR}/database/cli.sh" "$@"
        fi
        ;;
      purge)
        shift
        if [[ -n "${ORODC_IS_INTERACTIVE_MENU:-}" ]]; then
          execute_with_menu_return "${LIBEXEC_DIR}/database/purge.sh" "$@"
        else
          exec "${LIBEXEC_DIR}/database/purge.sh" "$@"
        fi
        ;;
      *)
        msg_error "Unknown database command: ${1:-<none>}"
        msg_info "Available: mysql, psql, import, export, cli, purge"
        exit 1
        ;;
    esac
    ;;

  # Tests commands - route to tests/*.sh modules
  tests)
    shift
    case "$1" in
      install)
        shift
        exec "${LIBEXEC_DIR}/tests/install.sh" "$@"
        ;;
      run)
        shift
        exec "${LIBEXEC_DIR}/tests/run.sh" "$@"
        ;;
      behat)
        shift
        exec "${LIBEXEC_DIR}/tests/behat.sh" "$@"
        ;;
      phpunit)
        shift
        exec "${LIBEXEC_DIR}/tests/phpunit.sh" "$@"
        ;;
      shell)
        shift
        exec "${LIBEXEC_DIR}/tests/shell.sh" "$@"
        ;;
      *)
        msg_error "Unknown tests command: ${1:-<none>}"
        msg_info "Available: install, run, behat, phpunit, shell"
        exit 1
        ;;
    esac
    ;;

  # Proxy commands - route to proxy/*.sh modules
  proxy)
    shift
    case "$1" in
      up)
        shift
        if [[ -n "${ORODC_IS_INTERACTIVE_MENU:-}" ]]; then
          execute_with_menu_return "${LIBEXEC_DIR}/proxy/up.sh" "$@"
        else
          exec "${LIBEXEC_DIR}/proxy/up.sh" "$@"
        fi
        ;;
      down)
        shift
        if [[ -n "${ORODC_IS_INTERACTIVE_MENU:-}" ]]; then
          execute_with_menu_return "${LIBEXEC_DIR}/proxy/down.sh" "$@"
        else
          exec "${LIBEXEC_DIR}/proxy/down.sh" "$@"
        fi
        ;;
      install-certs)
        shift
        if [[ -n "${ORODC_IS_INTERACTIVE_MENU:-}" ]]; then
          execute_with_menu_return "${LIBEXEC_DIR}/proxy/install-certs.sh" "$@"
        else
          exec "${LIBEXEC_DIR}/proxy/install-certs.sh" "$@"
        fi
        ;;
      restart)
        shift
        if [[ -n "${ORODC_IS_INTERACTIVE_MENU:-}" ]]; then
          execute_with_menu_return "${LIBEXEC_DIR}/proxy/restart.sh" "$@"
        else
          exec "${LIBEXEC_DIR}/proxy/restart.sh" "$@"
        fi
        ;;
      *)
        msg_error "Unknown proxy command: ${1:-<none>}"
        msg_info "Available: up, down, restart, install-certs"
        exit 1
        ;;
    esac
    ;;

  # Image commands - route to image/*.sh modules
  image)
    shift
    case "$1" in
      build)
        shift
        if [[ -n "${ORODC_IS_INTERACTIVE_MENU:-}" ]]; then
          execute_with_menu_return "${LIBEXEC_DIR}/image/build.sh" "$@"
        else
          exec "${LIBEXEC_DIR}/image/build.sh" "$@"
        fi
        ;;
      *)
        msg_error "Unknown image command: ${1:-<none>}"
        msg_info "Available: build"
        exit 1
        ;;
    esac
    ;;

  # Docker build command - non-interactive image builder (not in menu)
  docker-build)
    shift
    exec "${LIBEXEC_DIR}/docker-build.sh" "$@"
    ;;

  # Single-file commands
  init)
    shift
    if [[ -n "${ORODC_IS_INTERACTIVE_MENU:-}" ]]; then
      execute_with_menu_return "${LIBEXEC_DIR}/init.sh" "$@"
    else
      exec "${LIBEXEC_DIR}/init.sh" "$@"
    fi
    ;;

  list)
    shift
    if [[ -n "${ORODC_IS_INTERACTIVE_MENU:-}" ]]; then
      execute_with_menu_return "${LIBEXEC_DIR}/list.sh" "$@"
    else
      exec "${LIBEXEC_DIR}/list.sh" "$@"
    fi
    ;;

  conf)
    shift
    if [[ -n "${ORODC_IS_INTERACTIVE_MENU:-}" ]]; then
      execute_with_menu_return "${LIBEXEC_DIR}/conf.sh" "$@"
    else
      exec "${LIBEXEC_DIR}/conf.sh" "$@"
    fi
    ;;

  purge)
    shift
    if [[ -n "${ORODC_IS_INTERACTIVE_MENU:-}" ]]; then
      execute_with_menu_return "${LIBEXEC_DIR}/purge.sh" "$@"
    else
      exec "${LIBEXEC_DIR}/purge.sh" "$@"
    fi
    ;;

  config-refresh)
    shift
    if [[ -n "${ORODC_IS_INTERACTIVE_MENU:-}" ]]; then
      execute_with_menu_return "${LIBEXEC_DIR}/config-refresh.sh" "$@"
    else
      exec "${LIBEXEC_DIR}/config-refresh.sh" "$@"
    fi
    ;;

  ssh)
    shift
    if [[ -n "${ORODC_IS_INTERACTIVE_MENU:-}" ]]; then
      execute_with_menu_return "${LIBEXEC_DIR}/ssh.sh" "$@"
    else
      exec "${LIBEXEC_DIR}/ssh.sh" "$@"
    fi
    ;;

  install)
    shift
    if [[ -n "${ORODC_IS_INTERACTIVE_MENU:-}" ]]; then
      execute_with_menu_return "${LIBEXEC_DIR}/install.sh" "$@"
    else
      exec "${LIBEXEC_DIR}/install.sh" "$@"
    fi
    ;;

  cache)
    shift
    if [[ -n "${ORODC_IS_INTERACTIVE_MENU:-}" ]]; then
      execute_with_menu_return "${LIBEXEC_DIR}/cache.sh" "$@"
    else
      exec "${LIBEXEC_DIR}/cache.sh" "$@"
    fi
    ;;

  php)
    shift
    if [[ -n "${ORODC_IS_INTERACTIVE_MENU:-}" ]]; then
      execute_with_menu_return "${LIBEXEC_DIR}/php.sh" "$@"
    else
      exec "${LIBEXEC_DIR}/php.sh" "$@"
    fi
    ;;

  composer)
    shift
    if [[ -n "${ORODC_IS_INTERACTIVE_MENU:-}" ]]; then
      execute_with_menu_return "${LIBEXEC_DIR}/composer.sh" "$@"
    else
      exec "${LIBEXEC_DIR}/composer.sh" "$@"
    fi
    ;;

  exec)
    shift
    if [[ -n "${ORODC_IS_INTERACTIVE_MENU:-}" ]]; then
      execute_with_menu_return "${LIBEXEC_DIR}/exec.sh" "$@"
    else
      exec "${LIBEXEC_DIR}/exec.sh" "$@"
    fi
    ;;

  platform-update)
    shift
    if [[ -n "${ORODC_IS_INTERACTIVE_MENU:-}" ]]; then
      execute_with_menu_return "${LIBEXEC_DIR}/platform-update.sh" "$@"
    else
      exec "${LIBEXEC_DIR}/platform-update.sh" "$@"
    fi
    ;;

  doctor)
    shift
    if [[ -n "${ORODC_IS_INTERACTIVE_MENU:-}" ]]; then
      execute_with_menu_return "${LIBEXEC_DIR}/doctor.sh" "$@"
    else
      exec "${LIBEXEC_DIR}/doctor.sh" "$@"
    fi
    ;;

  # Convenient aliases for common Docker Compose commands
  start)
    # Alias: orodc start -> orodc compose up -d
    exec "${LIBEXEC_DIR}/compose.sh" up -d "$@"
    ;;

  stop)
    # Alias: orodc stop -> orodc compose stop
    shift
    exec "${LIBEXEC_DIR}/compose.sh" stop "$@"
    ;;

  restart)
    # Alias: orodc restart -> orodc compose restart
    shift
    exec "${LIBEXEC_DIR}/compose.sh" restart "$@"
    ;;

  up|down|logs|ps)
    # Aliases: orodc up/down/logs/ps -> orodc compose up/down/logs/ps
    cmd="$1"
    shift
    if [[ -n "${ORODC_IS_INTERACTIVE_MENU:-}" ]]; then
      execute_with_menu_return "${LIBEXEC_DIR}/compose.sh" "$cmd" "$@"
    else
      exec "${LIBEXEC_DIR}/compose.sh" "$cmd" "$@"
    fi
    ;;

  # Convenient aliases for database commands
  mysql)
    # Alias: orodc mysql -> orodc database mysql
    shift
    exec "${LIBEXEC_DIR}/database/mysql.sh" "$@"
    ;;

  psql)
    # Alias: orodc psql -> orodc database psql
    shift
    exec "${LIBEXEC_DIR}/database/psql.sh" "$@"
    ;;

  cli)
    # Alias: orodc cli -> orodc database cli
    shift
    exec "${LIBEXEC_DIR}/database/cli.sh" "$@"
    ;;

  # ERROR: Old syntax for some Docker Compose commands
  # Show helpful error message with new syntax for less common commands
  # Note: 'exec' is now a separate command for CLI container, not Docker Compose exec
  build|config|cp|create|events|export|images|kill|ls|pause|port|pull|push|rm|run|scale|stats|top|unpause|volumes|wait|watch)
    msg_error "Docker Compose commands must use 'compose' prefix"
    echo ""
    msg_info "Old syntax: orodc $1 ${*:2}"
    msg_info "New syntax: orodc compose $1 ${*:2}"
    echo ""
    msg_info "Run 'orodc help' for more information"
    exit 1
    ;;

  # Unknown command
  *)
    msg_error "Unknown command: $1"
    echo ""
    msg_info "Run 'orodc help' to see available commands"
    exit 1
    ;;
esac
